/**
 * HCS-U7 Widget v3.0.0 — Enterprise Adaptive Engine
 * Copyright (c) 2025-2026 Benjamin BARRERE / IA SOLUTION
 * Patents Pending FR2514274 | FR2514546
 * Built: 2026-02-11T11:21:26.242Z
 * DO NOT EDIT — generated from src/widget-v3/
 */
"use strict";(()=>{var dt=Object.defineProperty;var ye=Object.getOwnPropertySymbols;var ft=Object.prototype.hasOwnProperty,mt=Object.prototype.propertyIsEnumerable;var we=(e,t,n)=>t in e?dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,E=(e,t)=>{for(var n in t||(t={}))ft.call(t,n)&&we(e,n,t[n]);if(ye)for(var n of ye(t))mt.call(t,n)&&we(e,n,t[n]);return e};function ve(){return typeof window!="undefined"&&typeof document!="undefined"}function ke(){try{return window.location.href}catch(e){return""}}function xe(){try{return document.referrer}catch(e){return""}}function P(){try{let e="__hcs_test__";return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(e){return!1}}function B(){try{let e="__hcs_test__";return sessionStorage.setItem(e,"1"),sessionStorage.removeItem(e),!0}catch(e){return!1}}var gt="https://api.hcs-u7.online",i={config:{apiUrl:gt,version:"3.0.0",debug:!1,env:"production",token:null,tenantId:null,widgetPublicId:null,tokenPayload:null},remoteConfig:null,sessionValidated:!1,sessionToken:null,lastDecision:null,lastRisk:null,lastValidation:null,lastSeen:0,degraded:!1,ready:!1};function $(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t+e.charCodeAt(n)|0;return Math.abs(t).toString(36)}function Se(e){try{let n=(e+"====".substring(0,(4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/");return decodeURIComponent(atob(n).split("").map(o=>"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(t){return null}}function L(e){return!e||e.length<8?"***":e.substring(0,4)+"..."+e.substring(e.length-3)}var U=[],Z=!1;function V(e){Z=e}function F(){return Z}function a(e,t){if(!Z)return;let n={t:Date.now(),cat:e,data:t};U.push(n),U.length>200&&U.shift(),console.debug("[HCS-U7]["+e+"]",t)}function v(e){console.error("[HCS-U7] "+e)}function Ee(){return U.slice()}function Ce(e){if(!e||typeof e!="string")return null;let t=e.split(".");if(t.length!==2)return null;let n=Se(t[0]);if(!n)return null;try{let o=JSON.parse(n);return!o.tid||!o.exp||!o.v?null:o}catch(o){return null}}function De(e){return!e||e.includes(".")?!1:!!(/^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$/i.test(e)||/^c[a-z0-9]{20,30}$/.test(e))}function Ae(){let e=i.config,t=document.querySelectorAll('script[data-widget], script[data-tenant], script[src*="hcs-widget"]'),n=null;for(let o=0;o<t.length;o++)if(t[o].getAttribute("data-widget")||t[o].getAttribute("data-tenant")||(t[o].getAttribute("src")||"").indexOf("hcs-widget")!==-1){n=t[o];break}if(n&&n.getAttribute("data-widget")){e.widgetPublicId=n.getAttribute("data-widget");let o=n.getAttribute("data-tenant");if(o)if(De(o))e.tenantId=o;else{let r=Ce(o);r&&(e.token=o,e.tokenPayload=r,e.tenantId=r.tid)}a("init","Widget public ID from data-widget")}else if(n&&n.getAttribute("data-tenant")){let o=n.getAttribute("data-tenant");if(De(o))e.tenantId=o,e.token=null,a("init","Legacy tenant ID from data-tenant");else{let r=Ce(o);if(r)e.token=o,e.tokenPayload=r,e.tenantId=r.tid,r.dbg&&(e.debug=!0),r.env&&(e.env=r.env),a("init","Signed token parsed, tenant: "+L(r.tid));else return v("Invalid data-tenant token format"),!1}}else if(window.HCS_TENANT_ID)e.tenantId=window.HCS_TENANT_ID,e.token=null,a("init","Legacy window.HCS_TENANT_ID mode");else return v("Missing data-widget, data-tenant, or window.HCS_TENANT_ID"),!1;return n&&(n.getAttribute("data-debug")==="true"&&(e.debug=!0),n.getAttribute("data-env")&&(e.env=n.getAttribute("data-env")),n.getAttribute("data-api")&&(e.apiUrl=n.getAttribute("data-api"))),V(e.debug),a("init","Widget v"+e.version+" | tenant: "+L(e.tenantId)+" | mode: "+(e.token?"signed_token":"legacy")),!0}function f(e,t,n){let o=document.createElement(e);return o.style.cssText=t,n!==void 0&&(o.textContent=n),o}function A(e,...t){for(let n of t)e.appendChild(n)}function k(e){let t=document.getElementById(e);t&&t.remove()}function Q(e){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e()}function T(e){document.body?document.body.appendChild(e):Q(()=>document.body.appendChild(e))}var z=0,N=null,ne=0,Re=0,p=[],C=[],W=[],oe=[],Me=0,I={},j=[],G=[],X=[],re=0,_e=0,Pe=0,ie=[],Te=0,ee=0,Be=0,te=0,Le=0,Ve=[],Fe=[],He=0,h=[];function b(e){if(!e.length)return 0;let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t/e.length}function x(e){if(e.length<2)return 0;let t=b(e),n=0;for(let o=0;o<e.length;o++)n+=(e[o]-t)*(e[o]-t);return Math.sqrt(n/(e.length-1))}function Oe(e,t,n){let o=t.x-e.x,r=t.y-e.y,s=n.x-t.x,l=n.y-t.y,c=Math.abs(o*l-r*s),d=Math.sqrt(o*o+r*r),m=Math.sqrt(s*s+l*l),u=n.x-e.x,g=n.y-e.y,y=Math.sqrt(u*u+g*g),w=d*m*y;return w===0?0:2*c/w}function Ue(e){if(e.length<5)return .5;let t=[];for(let u=1;u<e.length;u++)t.push(e[u]-e[u-1]);let n=20,o=1/0,r=-1/0;for(let u of t)u<o&&(o=u),u>r&&(r=u);let s=r-o;if(s===0)return 0;let l=new Array(n).fill(0);for(let u of t)l[Math.min(Math.floor((u-o)/s*n),n-1)]++;let c=0,d=t.length;for(let u of l)if(u>0){let g=u/d;c-=g*Math.log2(g)}let m=Math.log2(n);return m>0?c/m:0}function pt(e){if(e.length<3)return 0;let t=b(e),n=x(e);if(n===0)return 0;let o=e.length,r=0;for(let s of e)r+=Math.pow((s-t)/n,3);return o/((o-1)*(o-2))*r}function bt(e){if(e.length<4)return 3;let t=b(e),n=x(e);if(n===0)return 0;let o=0;for(let r of e)o+=Math.pow((r-t)/n,4);return o/e.length-3}function ht(){if(p.length<10)return!1;let e=p.slice(-50),t=0,n=0;for(let o=2;o<e.length;o++)n++,Oe(e[o-2],e[o-1],e[o])<.001&&t++;return n>0&&t/n>.8}function yt(){if(h.length<10)return .5;let e=[];for(let o=1;o<h.length;o++)e.push(h[o]-h[o-1]);let t=0;if(e.length>2){let o=b(e),r=x(e);if(r>0){let s=0;for(let l=1;l<e.length;l++)s+=(e[l]-o)/r*((e[l-1]-o)/r);t=s/(e.length-1)}}let n=Ue(h);return n>.85&&Math.abs(t)<.1?.9:n<.15?.1:n}function D(){let e=Date.now();N===null&&(N=e),e-ne>3e3&&Re++,ne=e,h.length<500&&h.push(e)}function wt(e){D();let t={x:e.clientX,y:e.clientY,t:performance.now()};if(p.length>0){let n=p[p.length-1],o=t.t-n.t;if(o>0){let r=t.x-n.x,s=t.y-n.y,c=Math.sqrt(r*r+s*s)/o;if(C.length<500&&C.push(c),C.length>=2){let d=C[C.length-2];W.length<500&&W.push((c-d)/o)}if(p.length>=2){let d=p[p.length-2];oe.length<500&&oe.push(Oe(d,n,t))}}}p.length<500?p.push(t):p[p.length-1]=t}function vt(){D(),Me++}function kt(e){if(D(),["Shift","Control","Alt","Meta"].indexOf(e.key)!==-1)return;let t=performance.now();if(re>0){let o=t-re;o>0&&o<5e3&&X.length<500&&X.push(o)}let n=Object.keys(I);if(n.length>0&&j.length<500){let o=0;for(let s of n)I[s]>o&&(o=I[s]);let r=t-o;r>0&&r<5e3&&j.push(r)}I[e.code]=t,_e++}function xt(e){if(["Shift","Control","Alt","Meta"].indexOf(e.key)!==-1)return;let t=performance.now(),n=I[e.code];if(n!==void 0){let o=t-n;o>0&&o<2e3&&G.length<500&&G.push(o),delete I[e.code]}re=t}function St(){D(),Pe++;let e=performance.now(),t=window.scrollY||document.documentElement.scrollTop,n=e-ee;if(n>0&&ee>0){let o=t-Te;ie.length<500&&ie.push(Math.abs(o)/n);let r=o>0?1:o<0?-1:0;r!==0&&r!==te&&te!==0&&Be++,r!==0&&(te=r)}Te=t,ee=e}function Et(e){D(),Le++;for(let t=0;t<e.touches.length;t++){let n=e.touches[t];n.force!==void 0&&n.force>0&&Ve.push(n.force),n.radiusX!==void 0&&Fe.push((n.radiusX+n.radiusY)/2)}}function Ie(){D(),He++}function ze(){z=Date.now(),ne=z;let e={passive:!0};document.addEventListener("mousemove",wt,e),document.addEventListener("click",vt,e),document.addEventListener("keydown",kt,e),document.addEventListener("keyup",xt,e),document.addEventListener("scroll",St,{passive:!0,capture:!0}),document.addEventListener("touchstart",Et,e),document.addEventListener("touchmove",()=>D(),e),document.addEventListener("copy",Ie,e),document.addEventListener("paste",Ie,e)}function R(){let t=(Date.now()-z)/1e3,n=[];for(let o=1;o<h.length;o++)n.push(h[o]-h[o-1]);return{keystrokeIntervalAvg:b(j),keystrokeIntervalStd:x(j),keystrokeDwellAvg:b(G),keystrokeDwellStd:x(G),keystrokes:_e,flightTimeAvg:b(X),flightTimeStd:x(X),mouseVelocityAvg:b(C),mouseVelocityStd:x(C),mouseAccelerationAvg:b(W),mouseAccelerationStd:x(W),mouseCurvatureAvg:b(oe),mouseMovements:p.length,mouseClicks:Me,noMouseMovement:p.length===0,linearMovement:ht(),scrollEvents:Pe,scrollVelocityAvg:b(ie),scrollDirectionChanges:Be,touchEvents:Le,touchPressureAvg:b(Ve),touchRadiusAvg:b(Fe),timeToFirstInteraction:N?(N-z)/1e3:t,sessionDuration:t,idleGaps:Re,timingEntropy:Ue(h),copyPasteEvents:He,pageViews:1,microTimingEntropy:yt(),timingDistributionSkewness:pt(n),timingDistributionKurtosis:bt(n)}}function M(){let e=navigator;return{userAgent:e.userAgent||"",language:e.language||"",languages:e.languages||[],platform:e.platform||"",hardwareConcurrency:e.hardwareConcurrency||0,deviceMemory:e.deviceMemory||null,screenResolution:screen.width+"x"+screen.height,colorDepth:screen.colorDepth||0,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timezoneOffset:new Date().getTimezoneOffset(),webdriver:!!e.webdriver,plugins:e.plugins?e.plugins.length:0,canvas:Ct(),webgl:Dt(),touchSupport:"ontouchstart"in window,cookieEnabled:!!e.cookieEnabled,doNotTrack:e.doNotTrack||null,timestamp:Date.now()}}function Ct(){try{let e=document.createElement("canvas"),t=e.getContext("2d");return t?(e.width=200,e.height=50,t.textBaseline="top",t.font="14px Arial",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("HCS-U7",2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText("HCS-U7",4,17),$(e.toDataURL())):""}catch(e){return""}}function Dt(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"";let n=t.getExtension("WEBGL_debug_renderer_info");if(!n)return"";let o=t.getParameter(n.UNMASKED_VENDOR_WEBGL),r=t.getParameter(n.UNMASKED_RENDERER_WEBGL);return $(o+"~"+r)}catch(e){return""}}var K={allow:35,soft:60,challenge:80,bunker:92};var se={mode:"adaptive",thresholds:E({},K),softActions:["pow-lite","js-attestation","silent-retry"],challengeActions:["cognitive-lite"],bunkerPolicy:{enabled:!1,ttlSeconds:900},sampling:{telemetry:.25,fullSignals:.1},privacy:{maskPII:!0},timeouts:{configMs:800,validateMs:1200,pingMs:400},ui:{showBadge:!1,showToastOnChallenge:!0},killSwitch:!1,updatedAt:"",ttlSeconds:300},_=null;function We(){let e=i.config.widgetPublicId||i.config.tenantId||"unknown",t=typeof window!="undefined"?window.location.hostname:"";return"hcs:cfg:"+e+":"+t}function At(){if(!P())return null;try{let e=localStorage.getItem(We());if(!e)return null;let t=JSON.parse(e);return!t.config||!t.fetchedAt?null:t}catch(e){return null}}function Tt(e){if(P())try{localStorage.setItem(We(),JSON.stringify(e))}catch(t){}}function Ne(e){let t=(e.config.ttlSeconds||300)*1e3;return Date.now()-e.fetchedAt<t}async function je(){var o,r;if(_&&Ne(_))return a("config","Using memory cache"),_.config;let e=At();if(e&&Ne(e))return _=e,a("config","Using localStorage cache"),e.config;let t=i.config.widgetPublicId;if(!t)return a("config","No widgetPublicId \u2014 using safe defaults"),se;let n=((r=(o=e==null?void 0:e.config)==null?void 0:o.timeouts)==null?void 0:r.configMs)||se.timeouts.configMs;try{let s=new AbortController,l=setTimeout(()=>s.abort(),n),c=i.config.apiUrl+"/api/widgets/config?widgetPublicId="+encodeURIComponent(t),d=await fetch(c,{method:"GET",signal:s.signal,headers:{"X-HCS-Widget-Version":i.config.version}});if(clearTimeout(l),!d.ok)throw new Error("HTTP "+d.status);let m=await d.json();if(!m.thresholds||typeof m.mode!="string")throw new Error("Invalid config shape");let u={config:m,fetchedAt:Date.now()};return _=u,Tt(u),a("config","Fetched remote config (mode="+m.mode+")"),m}catch(s){return v("config_fetch_failed: "+((s==null?void 0:s.message)||"unknown")),e?(a("config","Using stale localStorage cache as fallback"),_=e,e.config):(a("config","No cache \u2014 using safe defaults"),se)}}function Ge(e){let t=[],n=0;e.webdriver&&(t.push("webdriver"),n+=50),e.plugins===0&&(t.push("no_plugins"),n+=20);let o=["headless","phantom","selenium","puppeteer","bot","crawler","spider"],r=e.userAgent.toLowerCase();return o.some(s=>r.indexOf(s)!==-1)&&(t.push("suspicious_ua"),n+=40),e.languages.length===0&&(t.push("no_languages"),n+=15),(e.hardwareConcurrency===0||e.hardwareConcurrency>32)&&(t.push("abnormal_hw"),n+=10),(!e.canvas||e.canvas.length<5)&&(t.push("invalid_canvas"),n+=25),(!e.webgl||e.webgl.length<5)&&(t.push("invalid_webgl"),n+=20),e.cookieEnabled||(t.push("cookies_disabled"),n+=10),(e.timezone==="UTC"||e.timezoneOffset===0)&&(t.push("utc_tz"),n+=5),{score:Math.min(100,n),signals:t,suspicious:n>=50}}function Xe(e){let t=[],n=0;return e.noMouseMovement&&e.sessionDuration>2&&(t.push("no_mouse"),n+=15),e.linearMovement&&(t.push("linear_mouse"),n+=20),e.keystrokes===0&&e.sessionDuration>5&&(t.push("no_keystrokes"),n+=5),e.microTimingEntropy>.85&&(t.push("artificial_timing"),n+=25),e.microTimingEntropy<.15&&e.sessionDuration>2&&(t.push("robotic_timing"),n+=20),e.timeToFirstInteraction<.1&&e.sessionDuration>1&&(t.push("instant_interaction"),n+=15),e.idleGaps===0&&e.sessionDuration>30&&(t.push("no_idle"),n+=10),e.keystrokeDwellStd<5&&e.keystrokes>10&&(t.push("uniform_dwell"),n+=15),e.mouseCurvatureAvg<.001&&e.mouseMovements>20&&(t.push("zero_curvature"),n+=15),{score:Math.min(100,n),signals:t}}function Ke(){return{storageAvailable:P()&&B(),cookiesEnabled:!!navigator.cookieEnabled,cspBlocked:!1,adblockDetected:!1}}function S(e){return Math.max(0,Math.min(100,e))}function qe(e,t){var r;let n=0,o=0;for(let s of Object.keys(t)){let l=(r=e[s])!=null?r:0,c=t[s];n+=S(l)*c,o+=c}return o>0?S(n/o):0}function Ye(e,t){return S(e*.4+t*.6)}function H(){return Math.floor(Date.now()/1e3)}function Je(e){return new Promise(t=>setTimeout(t,e))}function $e(e,t=.2){let n=e*t;return e+(Math.random()*2-1)*n}var It={fingerprint:.25,behavior:.3,automation:.2,integrity:.1,velocity:.1,network:.05},ae=0;function Ze(){let e=[],t=M(),n=Ge(t);e.push(...n.signals);let o=R(),r=Xe(o);e.push(...r.signals);let s=0;t.webdriver&&(s+=60),n.signals.includes("suspicious_ua")&&(s+=40),s=S(s);let l=Ke(),c=0;l.storageAvailable||(c+=20,e.push("no_storage")),l.cookiesEnabled||(c+=15,e.push("no_cookies")),l.cspBlocked&&(c+=10,e.push("csp_blocked")),c=S(c);let d=0,m=H();ae>0&&m-ae<2&&(d=30,e.push("rapid_assess")),ae=m;let g={fingerprint:S(n.score),behavior:S(r.score),automation:s,integrity:c,velocity:d,network:0},y=qe(g,It),w={total:y,components:g,reasons:e};return a("risk","Score: "+Math.round(y)+" | reasons: "+e.join(", ")),i.lastRisk=w,w}function Qe(e,t){var r,s,l;let n=(r=t==null?void 0:t.thresholds)!=null?r:K,o=e.total;return t!=null&&t.killSwitch||(t==null?void 0:t.mode)==="monitor"?"allow":(s=t==null?void 0:t.bunkerPolicy)!=null&&s.enabled&&o>=n.bunker?"bunker":o<n.allow?"allow":o<n.soft?"soft":o<n.challenge?"challenge":o<n.bunker?"hard_challenge":(l=t==null?void 0:t.bunkerPolicy)!=null&&l.enabled?"bunker":"block"}function le(){a("action","ALLOW \u2014 no friction")}function Rt(){return new Promise(e=>{let t=150+Math.random()*150,n=performance.now(),o=0,r=0;function s(){let l=performance.now()+5;for(;performance.now()<l;)o=(o<<5)-o+r|0,r++;performance.now()-n>=t?(a("soft","PoW-lite completed: "+r+" iterations in "+Math.round(performance.now()-n)+"ms"),e()):setTimeout(s,0)}s()})}function Mt(){return new Promise(e=>{let t=performance.now(),o=document.createElement("canvas").getContext("2d");o&&o.fillText("attest",0,0);let r=[typeof window.requestAnimationFrame=="function",typeof document.createTreeWalker=="function",typeof window.getComputedStyle=="function"],s=performance.now()-t;a("soft","JS attestation: "+r.filter(Boolean).length+"/3 checks, "+Math.round(s)+"ms"),e()})}async function _t(){let e=$e(500,.3);a("soft","Silent retry in "+Math.round(e)+"ms"),await Je(e)}function Pt(){a("soft","Token refresh requested")}async function et(){var t,n;let e=(n=(t=i.remoteConfig)==null?void 0:t.softActions)!=null?n:["pow-lite","js-attestation"];a("action","SOFT \u2014 executing: "+e.join(", "));for(let o of e)switch(o){case"pow-lite":await Rt();break;case"js-attestation":await Mt();break;case"silent-retry":await _t();break;case"token-refresh":Pt();break;default:a("soft","Unknown soft action: "+o)}}var ce="hcs-challenge-overlay";async function tt(e=!1){var n,o,r,s;let t=e?(o=(n=i.remoteConfig)==null?void 0:n.challengeActions)!=null?o:["cognitive-lite"]:["cognitive-lite"];a("action",(e?"HARD_":"")+"CHALLENGE \u2014 actions: "+t.join(", "));for(let l of t)switch(l){case"cognitive-lite":return ue();case"voice-if-enabled":return(s=(r=i.remoteConfig)==null?void 0:r.challengeActions)!=null&&s.includes("voice-if-enabled")&&a("challenge","Voice challenge not yet implemented \u2014 falling back to cognitive-lite"),ue();default:return a("challenge","Unknown challenge action: "+l),ue()}return!0}function ue(){return new Promise(e=>{k(ce);let t=30+Math.floor(Math.random()*40),n=5,o=Date.now(),r=f("div","position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999999;");r.id=ce;let s=f("div","background:white;border-radius:12px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);max-width:420px;width:90%;padding:30px;text-align:center;"),l=f("h3","margin:0 0 12px 0;color:#1e293b;font-family:system-ui,-apple-system,sans-serif;font-size:18px;","Human Verification"),c=f("p","margin:0 0 20px 0;color:#64748b;font-size:14px;font-family:system-ui,-apple-system,sans-serif;","Move the slider to "+t),d=document.createElement("input");d.type="range",d.min="0",d.max="100",d.value="0",d.style.cssText="width:100%;margin:16px 0;cursor:pointer;";let m=f("div","font-size:28px;font-weight:bold;color:#3b82f6;font-family:system-ui,-apple-system,sans-serif;margin-bottom:16px;","0"),u=f("button","padding:10px 30px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-family:system-ui,-apple-system,sans-serif;font-weight:600;","Validate"),g=f("p","color:#cbd5e1;font-size:10px;margin-top:16px;margin-bottom:0;font-family:system-ui,-apple-system,sans-serif;","Protected by HCS-U7");d.addEventListener("input",()=>{m.textContent=d.value}),u.addEventListener("click",()=>{let y=parseInt(d.value,10),w=Math.abs(y-t)<=n,O=Date.now()-o;a("challenge","Cognitive-lite result: "+(w?"PASS":"FAIL")+" (value="+y+", target="+t+", duration="+O+"ms)"),k(ce),e(w)}),A(s,l,c,d,m,u,g),r.appendChild(s),T(r)})}var de="hcs-bunker-overlay",fe="hcs:bunker:whitelist";function Bt(){if(!B())return!1;try{let e=sessionStorage.getItem(fe);if(!e)return!1;let t=JSON.parse(e);if(t.expiresAt>H()&&t.token)return a("bunker","Session whitelisted until "+new Date(t.expiresAt*1e3).toISOString()),!0;sessionStorage.removeItem(fe)}catch(e){}return!1}function Lt(e,t){if(B())try{let n={token:e,expiresAt:H()+t};sessionStorage.setItem(fe,JSON.stringify(n))}catch(n){}}async function me(){if(Bt()){a("bunker","Whitelisted \u2014 passing through"),i.sessionValidated=!0;return}return a("action","BUNKER \u2014 strict verification gate"),new Promise(e=>{var O,pe,be;k(de);let t=(be=(pe=(O=i.remoteConfig)==null?void 0:O.bunkerPolicy)==null?void 0:pe.ttlSeconds)!=null?be:900,n=f("div","position:fixed;top:0;left:0;width:100%;height:100%;background:#0f172a;display:flex;align-items:center;justify-content:center;z-index:999999;font-family:system-ui,-apple-system,sans-serif;");n.id=de;let o=f("div","text-align:center;max-width:400px;padding:40px;"),r=f("div","font-size:48px;margin-bottom:16px;","\u{1F6E1}\uFE0F"),s=f("h2","color:#f1f5f9;margin:0 0 8px 0;font-size:22px;","Security Verification Required"),l=f("p","color:#94a3b8;margin:0 0 24px 0;font-size:14px;line-height:1.5;","Enhanced security is active. Please complete the verification to continue."),c=40+Math.floor(Math.random()*20),d=3,m=f("p","color:#cbd5e1;margin:0 0 16px 0;font-size:13px;","Move the slider precisely to "+c),u=document.createElement("input");u.type="range",u.min="0",u.max="100",u.value="0",u.style.cssText="width:100%;margin:12px 0;cursor:pointer;";let g=f("div","font-size:32px;font-weight:bold;color:#60a5fa;margin-bottom:20px;","0"),y=f("button","padding:12px 36px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;","Verify"),w=f("p","color:#475569;font-size:10px;margin-top:24px;margin-bottom:0;","Protected by HCS-U7 Bunker Mode");u.addEventListener("input",()=>{g.textContent=u.value}),y.addEventListener("click",()=>{let he=parseInt(u.value,10);Math.abs(he-c)<=d?(a("bunker","Verification passed \u2014 whitelisting for "+t+"s"),Lt(i.sessionToken||"bunker-pass",t),i.sessionValidated=!0,k(de),e()):(m.textContent="Incorrect. Try again \u2014 move to "+c,m.style.color="#f87171",u.value="0",g.textContent="0",a("bunker","Verification failed (value="+he+", target="+c+")"))}),A(o,r,s,l,m,u,g,y,w),n.appendChild(o),T(n)})}function q(e){a("action","BLOCK \u2014 reason: "+e);let t=f("div","display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f1f5f9;font-family:system-ui,-apple-system,sans-serif;"),n=f("div","text-align:center;max-width:500px;padding:40px;"),o=f("div","font-size:64px;margin-bottom:20px;","\u{1F6E1}\uFE0F"),r=f("h1","color:#1e293b;margin:0 0 10px 0;font-size:24px;","Access Blocked"),s=f("p","color:#64748b;margin:0 0 20px 0;font-size:15px;","Your access has been blocked by HCS-U7 Protection."),l=f("p","color:#94a3b8;font-size:13px;","Reason: "+(typeof e=="string"?e:"Unknown")),c=f("p","color:#94a3b8;font-size:11px;margin-top:30px;","Protected by HCS-U7");A(n,o,r,s,l,c),t.appendChild(n),document.body.textContent="",document.body.appendChild(t)}async function Y(e,t={}){var r;let n=i.config.apiUrl+e,o=(r=t.timeoutMs)!=null?r:1200;try{let s=new AbortController,l=setTimeout(()=>s.abort(),o),c=E({"X-HCS-Widget-Version":i.config.version},t.headers||{});t.body&&(c["Content-Type"]="application/json");let d=await fetch(n,{method:t.method||"GET",signal:s.signal,headers:c,body:t.body?JSON.stringify(t.body):void 0});return clearTimeout(l),d.ok?d.status===204?null:await d.json():(a("api","HTTP "+d.status+" from "+e),null)}catch(s){return(s==null?void 0:s.name)==="AbortError"?v("Timeout ("+o+"ms) on "+e):a("api","Fetch error on "+e+": "+((s==null?void 0:s.message)||"unknown")),null}}async function nt(e){var s,l,c,d;let t=i.config,n=(c=(l=(s=i.remoteConfig)==null?void 0:s.timeouts)==null?void 0:l.validateMs)!=null?c:1200,o={fingerprint:M(),botSignals:{score:e.components.fingerprint,signals:e.reasons},behavior:R(),riskBreakdown:e,url:ke(),referrer:xe()};t.token?o.token=t.token:t.tenantId&&(o.tenantId=t.tenantId),t.widgetPublicId&&(o.widgetPublicId=t.widgetPublicId);let r=await Y("/widget/validate",{method:"POST",body:o,timeoutMs:n});return r?(a("validate","Server response: action="+r.action+" serverRisk="+((d=r.serverRisk)!=null?d:"n/a")),r.token&&(i.sessionToken=r.token),{action:r.action,token:r.token,expiresIn:r.expiresIn,serverRisk:r.serverRisk,flags:r.flags,reason:r.reason,score:r.score}):(a("validate","Backend unreachable \u2014 degraded mode"),i.degraded=!0,{action:"allow",reason:"api_unreachable",score:0})}async function ot(){var e,t,n;if(i.sessionValidated)return a("decision","Already validated this session"),(e=i.lastDecision)!=null?e:"allow";try{let o=Ze(),r=await nt(o),s=o.total;if(r&&r.serverRisk!==void 0&&(s=Ye(o.total,r.serverRisk),o.total=s),(r==null?void 0:r.action)==="block")return i.lastDecision="block",i.lastValidation=r,q(r.reason||"Server decision"),"block";if((r==null?void 0:r.action)==="bunker"&&((n=(t=i.remoteConfig)==null?void 0:t.bunkerPolicy)!=null&&n.enabled))return i.lastDecision="bunker",i.lastValidation=r,await me(),"bunker";let l=Qe(o,i.remoteConfig);switch(i.lastDecision=l,i.lastValidation=r,i.lastSeen=Date.now(),r!=null&&r.token&&(i.sessionToken=r.token),a("decision","Decision: "+l+" (score: "+Math.round(s)+")"),l){case"allow":le(),i.sessionValidated=!0;break;case"soft":await et(),i.sessionValidated=!0;break;case"challenge":case"hard_challenge":if(await tt(l==="hard_challenge"))i.sessionValidated=!0;else return q("Challenge failed"),i.lastDecision="block","block";break;case"bunker":await me();break;case"block":q("Risk threshold exceeded");break}return l}catch(o){return a("decision","Error in decision pipeline: "+((o==null?void 0:o.message)||"unknown")),i.degraded=!0,i.lastDecision="allow",i.sessionValidated=!0,le(),"allow"}}var rt=new Map;function it(e,t,n){let o=Date.now(),r=rt.get(e);return(!r||o>=r.resetAt)&&(r={count:0,resetAt:o+n},rt.set(e,r)),r.count>=t?!1:(r.count++,!0)}async function st(){var n,o,r;let e=i.config.widgetPublicId;if(!e)return;if(!it("ping",1,3e4)){a("ping","Rate limited \u2014 skipping");return}let t=(r=(o=(n=i.remoteConfig)==null?void 0:n.timeouts)==null?void 0:o.pingMs)!=null?r:400;await Y("/api/widgets/ping",{method:"POST",body:{widgetPublicId:e},timeoutMs:t}),a("ping","Sent")}var at="hcs-debug-badge",lt="hcs-debug-score";function ct(){var o,r;if(!F()||!((r=(o=i.remoteConfig)==null?void 0:o.ui)!=null&&r.showBadge)&&!i.config.debug)return;k(at);let e=f("div","position:fixed;bottom:10px;right:10px;background:rgba(30,41,59,0.8);color:#e2e8f0;padding:6px 12px;border-radius:8px;font-family:system-ui,-apple-system,sans-serif;font-size:11px;z-index:999998;cursor:pointer;user-select:none;backdrop-filter:blur(4px);border:1px solid rgba(148,163,184,0.2);");e.id=at;let t=f("span","font-weight:600;","\u{1F6E1}\uFE0F HCS Debug "),n=f("span","margin-left:4px;","...");n.id=lt,e.appendChild(t),e.appendChild(n),e.addEventListener("click",()=>{var s;console.group("[HCS-U7] Debug Details"),console.log("Version:",i.config.version),console.log("Decision:",i.lastDecision),console.log("Risk:",i.lastRisk),console.log("Validation:",i.lastValidation),console.log("Degraded:",i.degraded),console.log("Remote config:",(s=i.remoteConfig)==null?void 0:s.mode),console.groupEnd()}),T(e)}function ut(e,t){if(!F())return;let n=document.getElementById(lt);if(!n)return;let o=t==="allow"?"#4ade80":t==="soft"?"#a3e635":t==="challenge"||t==="hard_challenge"?"#fbbf24":t==="bunker"?"#f97316":"#f87171",r=t==="allow"?"\u2705":t==="soft"?"\u{1F7E2}":t==="challenge"||t==="hard_challenge"?"\u26A0\uFE0F":t==="bunker"?"\u{1F6E1}\uFE0F":"\u274C";n.textContent=r+" "+Math.round(e),n.style.color=o}var J="3.0.0";ve()&&(ze(),Vt());async function Vt(){var e,t;if(Ae()){i.config.version=J,a("boot","Widget v"+J+" booting");try{if(i.remoteConfig=await je(),a("boot","Remote config loaded (mode="+i.remoteConfig.mode+")"),i.remoteConfig.killSwitch){a("boot","Kill switch active \u2014 monitor only"),i.ready=!0,ge();return}}catch(n){a("boot","Remote config failed \u2014 using safe defaults"),i.degraded=!0}(t=(e=i.remoteConfig)==null?void 0:e.ui)!=null&&t.showBadge&&V(!0),Ft(),ct(),st().catch(()=>{}),Q(async()=>{var n,o;try{let r=await ot();ut((o=(n=i.lastRisk)==null?void 0:n.total)!=null?o:0,r),i.ready=!0,i.lastSeen=Date.now(),ge(),a("boot","Boot complete \u2014 decision: "+r)}catch(r){v("Boot decision failed: "+((r==null?void 0:r.message)||"unknown")),i.degraded=!0,i.ready=!0,ge()}})}}function ge(){let e={ready:i.ready,lastDecision:i.lastDecision,lastSeen:i.lastSeen,version:J,degraded:i.degraded};try{Object.defineProperty(window,"HCS_STATUS",{value:Object.freeze(e),writable:!1,configurable:!0,enumerable:!0})}catch(t){window.HCS_STATUS=e}}function Ft(){var n,o,r;if(!F())return;let e=i.config;if(!(((n=e.tokenPayload)==null?void 0:n.dbg)||!e.token)){a("debug","Debug requested but not authorized by token"),V(!1);return}window.__HCS_DEBUG__=Object.freeze({version:J,tenantId:L(e.tenantId),mode:(r=(o=i.remoteConfig)==null?void 0:o.mode)!=null?r:"unknown",env:e.env,getFingerprint:()=>M(),getBehavior:()=>R(),getLogs:()=>Ee(),getRisk:()=>i.lastRisk?E({},i.lastRisk):null,getDecision:()=>i.lastDecision,getConfig:()=>i.remoteConfig?E({},i.remoteConfig):null,isDegraded:()=>i.degraded}),a("debug","Debug API exposed on window.__HCS_DEBUG__")}})();
